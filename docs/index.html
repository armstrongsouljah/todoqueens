<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x" crossorigin="anonymous">

    <title>Reviews Bootstrap</title>
  </head>
  <body>
    <nav class="navbar navbar-expand-md navbar-dark bg-dark" aria-label="Fourth navbar example">
        <div class="container-fluid">
          <a class="navbar-brand" href="#">Expand at md</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample04" aria-controls="navbarsExample04" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
    
          <div class="collapse navbar-collapse" id="navbarsExample04">
            <ul class="navbar-nav me-auto mb-2 mb-md-0">
              <li class="nav-item">
                <a class="nav-link active" aria-current="page" href="#">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">Link</a>
              </li>
              <li class="nav-item">
                <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>
              </li>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="dropdown04" data-bs-toggle="dropdown" aria-expanded="false">Dropdown</a>
                <ul class="dropdown-menu" aria-labelledby="dropdown04">
                  <li><a class="dropdown-item" href="#">Action</a></li>
                  <li><a class="dropdown-item" href="#">Another action</a></li>
                  <li><a class="dropdown-item" href="#">Something else here</a></li>
                </ul>
              </li>
            </ul>
            <form>
              <input class="form-control" type="text" placeholder="Search" aria-label="Search">
            </form>
          </div>
        </div>
      </nav>
   <div class="continer-fluid">
    <img src="../images/banner.jpg" class="img-fluid" alt="Food">
   </div>
    <div class="container">
        <div class="row my-2">
            
            <div class=" col-2 justify-content-md-center">
                
                <!-- <div class="alert alert-primary" role="alert">
                    A simple primary alert—check it out!
                  </div>
                  <div class="alert alert-secondary" role="alert">
                    A simple secondary alert—check it out!
                  </div>
                  <div class="alert alert-success" role="alert">
                    Your nessage has been sent.
                  </div>
                  <div class="alert alert-danger" role="alert">
                    A simple danger alert—check it out!
                  </div>
                  <div class="alert alert-warning" role="alert">
                    A simple warning alert—check it out!
                  </div>
                  <div class="alert alert-info" role="alert">
                    A simple info alert—check it out!
                  </div>
                  <div class="alert alert-light" role="alert">
                    A simple light alert—check it out!
                  </div>
                  <div class="alert alert-dark" role="alert">
                    A simple dark alert—check it out!
                  </div> -->
                <!-- <form>
                    <div class="mb-3">
                      <label for="full_name" class="form-label">Full Name:</label>
                      <input type="text" class="form-control" id="full_name" aria-describedby="emailHelp">
                      <div id="fullNameHelp" class="form-text">Your full name</div>
                    </div>
                    <div class="mb-3">
                        <label for="email" class="form-label">Email address</label>
                        <input type="email" class="form-control" id="email" aria-describedby="emailHelp">
                        <div id="emailHelp" class="form-text">We'll never share your email with anyone else.</div>
                      </div>
                      <div class="mb-3">
                        <label for="exampleFormControlTextarea1" class="form-label">Message</label>
                        <textarea class="form-control" id="exampleFormControlTextarea1" rows="3"></textarea>
                      </div>
                    <button type="submit" class="btn btn-outline-primary">Submit</button>
                  </form> -->

                  <span class="btn btn-outline-danger mt-2" data-bs-toggle="modal" data-bs-target="#reviewForm2">Post a Review</span>
                  <!-- Button trigger modal -->
    <!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
        Launch demo modal
    </button> -->
  
  <!-- Modal -->
  <div class="modal fade" id="reviewForm2" tabindex="-1" aria-labelledby="reviewForm2" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Review form</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <form id="reviewForm" method="POST" action="#">
                <div class="mb-3">
                  <label for="full_name" class="form-label">Full Name:</label>
                  <input type="text" name="full_name" class="form-control" id="full_name" aria-describedby="emailHelp">
                  <div id="fullNameHelp" class="form-text">Your full name</div>
                </div>
                <!-- <div class="mb-3">
                    <label for="email" class="form-label">Email address</label>
                    <input type="email" class="form-control" id="email" aria-describedby="emailHelp">
                    <div id="emailHelp" class="form-text">We'll never share your email with anyone else.</div>
                  </div> -->
                  <div class="mb-3">
                    <label for="exampleFormControlTextarea1" class="form-label">Message</label>
                    <textarea name="message" class="form-control" id="exampleFormControlTextarea1" rows="3"></textarea>
                  </div>
                <button type="submit" class="btn btn-outline-primary">Submit</button>
                <span id="loader"></span>
              </form>
        </div>
      </div>
    </div>
  </div>
            </div>
            <div class="col-10 justify-content-center reviews-section">
                <h4>Reviews</h4>
            </div>
            <div class="col">
              <form id="login" action="." method="POST">
                <input type="text" name="username" id="username" placeholder="janedoe">
                <input type="password" name="password" id="password" placeholder="*****"/>
                <input type="submit" value="Login" />
              </form>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js" integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js" integrity="sha384-Atwg2Pkwv9vp0ygtn1JAojH0nYbwNJLPhwyoVbhoPwBhjQPR5VtM2+xf0Uwh9KtT" crossorigin="anonymous"></script>
    <script>
      var myModal = new bootstrap.Modal(document.getElementById('reviewForm2'), {
        keyboard: false
      })
      const reviewBtn = document.querySelector('#reviewBtn');
      const reviewForm = document.querySelector('#reviewForm');
      const reviewsHolder = document.querySelector('.reviews-section');
      const loader = document.querySelector('#loader');
      const backendUrl = 'https://todoqueens.herokuapp.com/reviews';
      const authLocal = 'http://localhost:4000/auth/'

      reviewForm.addEventListener('submit', e => {
        e.preventDefault();
        console.log(e);
        // myModal.hide()
        let message = e.target.message.value;
        let fullName = e.target.full_name.value;
        console.log(message, fullName);

        // perform a request to save data
        if(fullName && message) {
          console.log('saving data...')
          loader.textContent = 'Savinng......'
          // use fetch api to save data on the server
          fetch(`${backendUrl}/add`, {
            headers: {
              'Content-Type':'application/json'
            },
            body: JSON.stringify({fullName, message}),
            method: 'POST'
          })
          .then(response => response.json())
          .then(data => {
            console.log(data)
            
            window.location.reload()
            loader.textContent = '';

          })
          .catch(error => console.error(error.toString()));
        }
    
      })


    function deleteReview(id) {
      let s = id
      let deleteUrl = `${backendUrl}/${s}/delete`
      console.log(deleteUrl)
      fetch(deleteUrl, {
        method:'DELETE',
      })
             .then(response => response.json())
             .then(data => {
               window.location.reload()
             })
             .catch(error => console.error(error));
    }

    function createCard(review) {
    let {fullName, message, _id} = review;
    const reviewCard = document.createElement('div');
       reviewCard.classList= 'card mb-2';
       reviewCard.setAttribute('id', _id)

       // h4 for reviewer name
       const cardHeader = document.createElement('div');
       cardHeader.className = 'card-header';

       // div holding the card details
       const cardContent = document.createElement('div');
       cardContent.className = 'card-body';

       //paragraph holding the review text
       const cardText = document.createElement('p');
       cardText.className = 'text-responsive';

       cardHeader.textContent = fullName;
       reviewCard.appendChild(cardHeader); // adds reviewer name to the DOM
       
       // add review
       cardText.textContent = message;
       cardContent.appendChild(cardText);

       // now add reviews to the page
       reviewCard.appendChild(cardContent);

       reviewCard.addEventListener('dblclick', (e) => {
         let reviewElement = e.target.parentElement;
         let _id = reviewElement.getAttribute('id')
         if(confirm('Are you sure you want to delete the review?')) {
           deleteReview(_id) 
          // console.log(_id)
         }
         return;
       })
       reviewsHolder.appendChild(reviewCard);


       // perform login
       const loginForm = document.querySelector("#login");
       loginForm.addEventListener('submit', (e) => {
         e.preventDefault();
         const loginData = {
           username: loginForm.username.value,
           password: loginForm.password.value
         };

         // send the data for processing
         let loginUrl = `${authLocal}login`
         fetch(loginUrl, {
           body: JSON.stringify(loginData),
           method:'POST',
           headers: {
             'Content-Type':'application/json'
           }
         }).then(response => response.json())
         .then(data => {
           const {token} = data;
           localStorage.setItem('token', token)
         })
         .catch(error => console.error(error));
       })
}


// console.log(reviewsHolder)

      // get all stored review
      setTimeout(() => {
        fetch(backendUrl)
             .then(response => response.json())
             .then(responsData => {
                let reviews = responsData.reviews.data;
               
               // add the retuned data to the DOM
               reviews.map(review => {
                 return createCard(review);
               })
               

             })
             .catch(error => console.error('error happened ', error))
      }, 20)
      
    </script>
   
  </body>
</html>